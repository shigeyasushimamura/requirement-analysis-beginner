# ADR-002: 順序逆転を許容するシーケンス番号ベースのステートマシン

- **Status:** Accepted
- **Date:** 2025-12-24

# Context

- モバイルネットワークの不安定さにより、イベントがサーバに届く順序が前後する(例：配送中より先に配達完了が届く)「追い越し問題」が発生する
- 到着順に単純に上書きすると、最新の状態が過去のデータで汚染されるリスクがある

# Decision

- クライアント側シーケンス採番:各端末でイベント生成時に sequenceNumber を付与する
- 冪等な状態更新ロジック: Shipment エンティティは、自身の lastSquenceNumber より大きい番号のイベントのみを受け入れ、状態を更新する。古いイベントは履歴として記録のみ行い、現在のステータスには反映しない

# Consequence

- Positive: 到着順に関わらず、最終的なエンティティの状態が常に最新の状態に収束する(結果整合性)
- Negative: 端末側のクロック同期や、複数端末からの同時更新におけるコンフリクト解決が必要
