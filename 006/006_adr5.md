# ADR-005: パフォーマンス最適化のための CQRS パターンの適用

- **Status:** Accepted
- **Date:** 2025-12-19

# Context

- ADR-004 で Redis と Lua を採用したが、ドメインロジック(Typescript)とデータ操作(Lua)の乖離が懸念される
- 「書き込み(在庫確保)」は極限まで軽量化が求められる一方、「読み取り(表示確認)」はリッチなドメインモデルとして扱いたい。単一モデルで量対応するのは困難。

# Decision

- CQRS(Command Query Responsibility Segregation)パターンを適用する
- Command(Write): Lua スクリプトを用い、プリミティブな値操作として高速に処理する(ドメインモデルを経由しない)
- Query(read): Redis からデータを取得し、Typescript のドメインモデル(Entity/VO)に復元してから利用する

# Consequence

- Positive: 書き込み性能を最大化しつつ、読み取り時のコードの保守性・可読性を維持できる
- Negative: 「書き込みロジック(Lua)」と「読み取りロジック(TS)」で仕様の二重管理が発生するリスクがある(例：バリデーションルールの同期漏れ)
