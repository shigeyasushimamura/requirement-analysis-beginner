# ADR-004: 高負荷在庫引き当てにおける Redis と Lua スクリプトの採用

- **Status:** Accepted
- **Date:** 2025-12-19

# Context

- フラッシュセール時には秒間数万リクエストのスパイクアクセスが発生する
- RDB の悲観的ロック(行ロック)では、DB コネクション枯渇やロック待ちによるタイムアウトが発生し、システムが停止する恐れがある。
- 「10 分後の在庫開放」をリアルタイムかつ低負荷で行う必要がある

# Decision

- 在庫管理のプライマリストアとして、Redis(In-Memory Data Store)を採用する
- 整合性担保のため、排他制御ロジックを Lua スクリプトに記述して、Redis 上でアトミックに実行する

# Consequence

- Positive: メモリ内操作による圧倒的なスループットを実現できる。Lua によりロック競合なしで「早いもの勝ち」を保証できる。TTL 機能により、期限切れ在庫の自動開放が可能
- Negative: RDB のような ACID トランザクション(複数テーブルに跨る整合性)の担保が難しい。データの永続性の設定を誤るとデータロストのリスクがある
