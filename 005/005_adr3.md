# ADR-005: 予約期間と開錠権限の分離によるドメインモデル設計

- **Status:** Accepted
- **Date:** 2025-12-12

# Context

- 「ユーザが予約した時間(課金対象)」と「実際に鍵が開く時間(前後マージンを含む)」にはズレがある
- これらを単一のオブジェクトや DB カラムで管理すると、管理ロジックが各所に散らばり、変更に弱くなる
- 値の整合性(開始<終了)を毎回チェックするのは責任の侵害でもある

# Decision

- ValueObject(TimeRange)を導入して、期間計算ロジック(Overlaps, expand)を振る舞いとして持つ
- Entity を分離した。ユーザの契約を表す Reservation(集約ルート)と、物理デバイスの挙動を LockCredential(Reservation 経由で作成される)を分ける
- Reservation に grantLockCredential()メソッドを持たせて、「5 分前に入室可能にする」といったビジネスルールを、このメソッド内にカプセル化する。

# Consequence

- Positive: 予約ルール(マージン変更など)が変わっても、影響範囲を Entity 内に限定できる。テストが容易になる(副作用がない計算のため)
- Negative:クラス数が増え、単純な CRUD に比べると、コード量が増大する(ボイラーテンプレートの増大)
