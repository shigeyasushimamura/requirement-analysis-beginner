# ADR-005: 外部システム連携における補償トランザクションの導入

- **Status:** Accepted
- **Date:** 2025-12-12

# Context

- スマートロック API(外部システム)は RDB のトランザクションに参加できないため、原子性(Atomicity)が保証できない。
- 「DB には予約があるが、現地で鍵が開かない」あるいわその逆といった不整合を防ぐ必要がある
- Kafka などのメッセージングキューをもちいたイベントソーシングは、初期フェーズのシステム規模に対して、オーバーエンジニアリングである

# Decision

- 補償トランザクションパターンを採用する
- 予約エンティティにステータス(Pending, Confirmed, Cancelled)を持たせる
- フロー: まず Pending で保存->外部 API コール->成功なら、Confirmed, 失敗なら Cancelled に更新する(後始末)
- サーバクラッシュ時の「空白時間」対策として、別途バッチ処理でのポーリングを想定する

# Consequence

- Positive: 外部 API ダウン時でも、システム内部のデータ不整合(ゴースト予約)を防げる。Kafka 等を導入せず、RDB のみで完結するので初期コストが低い
- Negative: 一時的に「確定していないデータ」が DB に存在する状態になるので、検索時にステータス条件が必須となる
