# ADR-005: 予約期間の整合性確保に PostgreSQL の排他制約を採用

- **Status:** Accepted
- **Date:** 2025-12-12

# Context

- 予約システムにおいて、「ダブルブッキング(時間の重複)」は絶対に回避すべき致命的な問題である。
- 検索エンジン(Elasticsearch)や NOSQL をもちいたアプローチでは、インデックス更新の遅延(Eventual Consistency)により、ユーザ間の並行リクエスト時に重複が発生するリスクがあった。
- アプリケーション層でのチェック(Read-then-Write)は、ロック制御が複雑化して、バグの温床になりやすい

# Decision

- データストアに**PostgreSQL**を採用する
- 重複チェックにはアプリケーションロジックではなく、PostgreSQL の`EXCLUDE`制約(GIST インデックス+tstzrange 型)を使用する。
- アプリケーションは DB からの排他制約違反エラー(Code:23P01)をハンドリングして、ドメインエラーとしてユーザに返す

# Consequence

- Positive: DB カーネルレベルでの厳密な排他制御により、ダブルブッキングを 100%防止できる。アプリ側のコードが単純化される
- Negative: PostgreSQL 固有機能への依存度が高まる。
