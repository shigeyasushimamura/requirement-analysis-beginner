# ADR-001: 会議室予約における重複防止と整合性担保

- Status: Accepted
- Date: 2025-11-26
- Context: 社内会議室予約システム(簡易版)

# Context(背景)

会議室予約システムにおいて、「同じ部屋・同じ時間帯に複数の予約が入る(ダブルブッキング)」は許容されない。しかし、アプリケーションレベルのチェック(`SELECT`して確認後に`INSERT`)だけでは、並行リクエスト時に「書き込みスキュー」によるデータ不整合が発生するリスクがある。また、予約時間は「1 時間単位」「正時スタート」というビジネスルールが存在する。

# Decision (決定事項)

整合性を担保するため、以下の 3 点のアーキテクチャを採用する。

1. **Value Object による不整値のガード**

- 予約時間枠をプリミティブな型(Date 型など)でなく、専用の`ReservationTimeSlot`クラスとして定義する
- コンストラクタ内で「正時開始」「1 時間固定」などのルールを強制して、不正な値の作成をロジックで防ぐ

2. **Domain Service**による重複チェック

- 「重複していないか」とう判断は、予約単体(Entity)ではなく、予約の集合を扱う`ReservationDomainService`の責務とする
- Entity が Repository に依存することを防ぐため(情報粒度を Entity と Service でわけるため)

3. **データベースのユニーク制約**

- 書き込みスキュー対策として、悲観的ロックなどの厳格なアプリ実装を採用しない
- 代わりに、データベースカラム`(room_id, start_at)`に対して、複合ユニーク制約を設定する

# Consequence(結果)

- Positive:
  - データの完全性が RDB レベルで 100%保証される
  - アプリケーション側の排他制御ロジックが不要になり、実装コストとバグリスクを抑えることが出来る
  - Value Object の導入により、不変性が保たれ、副作用のないコードになりメンテナンス性が上がる
- Negative:
  - 将来的に「15 分単位の予約」や「不定期間の予約」に仕様が変更される場合、単純な複合ユニーク制約(開始時間のみ)では対応できなくなる。
    - 予約単位が可変になった場合は、「範囲」の重複チェックを DB 機能に頼らず実現するため、**Time Slot Expansion Pattern**を採用する。予約期間をシステムの最小単位(例：15 分)のレコード群に展開して、`room_occupied_slots`テーブルの`(room_id, slot_start_time)`複合主キー制約により物理的な重複を排除する。
